<!DOCTYPE html>
<html>

<head>
  <!-- Required meta tags-->
  <meta charset="utf-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000">
  <!-- Your app title -->
  <title></title>
  <!-- Path to Framework7 Library CSS -->
  <link rel="stylesheet" href="css/framework7.css">
  <link rel="stylesheet" href="css/framework7-icons.css">
  <link rel="stylesheet" href="css/style.css">
  <style>
    .ios .searchbar:after {
      background-color: white;
    }

    .ios .card {
      margin: 8px 0 0 0;
    }

    .ios .navbar .left {
      margin-right: 0px;
    }

    .ios .navbar b,
    .ios .navbar .title {
      font-weight: 500;
    }

    p {
      font-size: 16px;
      line-height: 1.5rem;
    }

    .ios .navbar .title {
      font-size: 16px;
    }

    .ios .media-list .item-title,
    .ios li.media-item .item-title {
      font-weight: 500;
    }
  </style>
</head>

<body>
  <!-- App root element -->
  <div id="app">
    <!-- 左侧边栏 -->
    <div class="panel panel-left panel-cover anpanel annotator">
      <div class="block" id="Mynote">
        <div id="ancontent">
          <div class="texbg">暂无批注</div>
        </div>
      </div>
    </div>

    <!-- 右侧侧边栏 -->
    <div class="panel panel-right panel-cover anpanel annotator" id="anpanel">

      <div id="ancontent2">
        <div class="texbg">暂无批注</div>
      </div>
    </div>

    <!-- Statusbar overlay -->
    <!-- Your main view, should have "view-main" class -->
    <div class="view view-main">
      <!-- Initial Page, "data-name" contains page name -->
      <!-- 头部标题栏 -->
      <div class="navbar">
        <div class="navbar-inner">
          <div class="left">
            <a href="#" class="item-link icon" id="back">
              <i class="icon f7-icons" style="font-size: 25px">chevron_left</i>
            </a>
          </div>
          <div class="title">
            <span id="title"></span>
            <div class="stitle">
              <span id="count"></span>
              <i class="icon f7-icons more">down</i>
            </div>
          </div>

          <div class="right">

          </div>
        </div>
      </div>

      <!-- 批注工具栏 -->
      <div class="toolbar tabbar-labels">
        <div class="toolbar-inner">

          <!-- 批注内容 -->
          <a href="#" class="tab-link an-button panel-open" data-panel="left">
            <i class="icon f7-icons ios-only">favorites_fill</i>
            <span class="tabbar-label">批注内容</span>
          </a>


          <!-- 工具栏标签 -->
          <a href="#" class="tab-link an-button popup-open" id="button0">
            <!-- Different icons for iOS and MD themes -->
            <i class="icon f7-icons ios-only">chat_bubble</i>
            <span class="tabbar-label">背景高亮</span>
          </a>
          <a href="#" class="tab-link an-button popup-open" id="button1">
            <i class="icon f7-icons ios-only">bolt_fill</i>
            <span class="tabbar-label">文字高亮</span>
          </a>
          <a href="#" class="tab-link an-button popup-open" id="button2">
            <i class="icon f7-icons ios-only">chevron_up</i>
            <span class="tabbar-label">加粗</span>
          </a>
          <a href="#" class="tab-link an-button popup-open" id="button3">
            <i class="icon f7-icons ios-only">bars</i>
            <span class="tabbar-label">下划线</span>
          </a>

          <!-- 其他批注 -->
          <a href="#" class="tab-link an-button panel-open" data-panel="right" id="button5">
            <i class="icon f7-icons ios-only">forward_fill</i>
            <span class="tabbar-label">其他批注</span>
          </a>
        </div>
      </div>
      <!-- 内容区域 -->
      <div class="page-content">
        <div class="list media-list annotator">
          <ul>
            <li>
              <a href="#" class="item-link item-content class">
                <div class="item-media">
                  <img src="images/student.jpg" width="44" />
                </div>
                <div class="item-inner">
                  <div class="item-title">
                    <div class="item-title size-14">我的批注</div>
                  </div>
                  <div class="item-subtitle size-14" id="score"></div>
                </div>
              </a>
            </li>
          </ul>
        </div>
        <div id="txblock">
          <div class="block" id="box" style="color:black"></div>
        </div>
      </div>
      <!-- 弹出页面 -->
      <!-- 修改批注 -->
      <div class="popup popup5 annotator">
        <div class="block annotator">
          <p>
            <i class="icon f7-icons ios-only">help_fill</i> 修改批注</p>
          <blockquote class="blockquote bqcolor1" id="bqcolor">
            <p id="old"></p>
            <p id="sendID" style="display: none"></p>
          </blockquote>
          <p class="content">
            <i class="icon f7-icons ios-only">bookmark_fill</i> 批注内容</p>
          <!-- Close Popup -->
          <div class="item-media">
            <i class="icon demo-list-icon"></i>
          </div>
          <textarea placeholder="请输入批注" id="mod" cols="45" rows="6" class="textarea"></textarea>
          <p class="row">
            <button class="col-30 button button-fill panel-open popup-close" id="modadd">修改批注</button>
            <button class="button col-30  popup-close">取消</button>
          </p>
        </div>
      </div>


      <!-- 添加背景高亮批注 -->
      <div class="popup popup0 annotator">
        <div class="block annotator">
          <p>
            <i class="icon f7-icons ios-only">chat_fill</i> 添加批注</p>
          <blockquote class="blockquote bqcolor0">
            <p id="selectedtxt0" class="text_overflow3"></p>
          </blockquote>
          <p class="content">
            <i class="icon f7-icons ios-only">bookmark_fill</i> 批注内容</p>
          <!-- Close Popup -->
          <div class="item-media">
            <i class="icon demo-list-icon"></i>
          </div>
          <textarea placeholder="请输入批注" id="note0" cols="45" rows="6" class="textarea"></textarea>
          <p class="row">
            <button class="col-30 button button-fill panel-open popup-close" id="add0">添加批注</button>
            <button class="button col-30  popup-close" onclick="getPassage('ture')">取消</button>
          </p>
        </div>
      </div>

      <!-- 添加文字高亮批注 -->
      <div class="popup popup1 annotator">
        <div class="block annotator">
          <p>
            <i class="icon f7-icons ios-only">help_fill</i> 添加批注</p>
          <blockquote class="blockquote bqcolor1">
            <p id="selectedtxt1" class="text_overflow3"></p>
          </blockquote>
          <p class="content">
            <i class="icon f7-icons ios-only">bookmark_fill</i> 批注内容</p>
          <!-- Close Popup -->
          <div class="item-media">
            <i class="icon demo-list-icon"></i>
          </div>
          <textarea placeholder="请输入批注" id="note1" cols="45" rows="6" class="textarea"></textarea>
          <p class="row">
            <button class="col-30 button button-fill panel-open popup-close" id="add1">添加批注</button>
            <button class="button col-30  popup-close" onclick="getPassage('ture')">取消</button>
          </p>
        </div>
      </div>

      <!-- 添加加粗批注 -->
      <div class="popup popup2 annotator">
        <div class="block annotator">
          <p>
            <i class="icon f7-icons ios-only">heart_fill</i> 添加批注</p>
          <blockquote class="blockquote bqcolor2">
            <p id="selectedtxt2" class="text_overflow3"></p>
          </blockquote>
          <p class="content">
            <i class="icon f7-icons ios-only">bookmark_fill</i> 批注内容</p>
          <!-- Close Popup -->
          <div class="item-media">
            <i class="icon demo-list-icon"></i>
          </div>
          <textarea placeholder="请输入批注" id="note2" cols="45" rows="6" class="textarea"></textarea>
          <p class="row">
            <button class="col-30 button button-fill panel-open popup-close" id="add2">添加批注</button>
            <button class="button col-30  popup-close" onclick="getPassage('ture')">取消</button>
          </p>
        </div>
      </div>

      <!-- 添加下划线批注 -->
      <div class="popup popup3 annotator">
        <div class="block annotator">
          <p>
            <i class="icon f7-icons ios-only">mic_fill</i> 添加批注</p>
          <blockquote class="blockquote bqcolor3">
            <p id="selectedtxt3" class="text_overflow3"></p>
          </blockquote>
          <p class="content">
            <i class="icon f7-icons ios-only">bookmark_fill</i> 批注内容</p>
          <!-- Close Popup -->
          <div class="item-media">
            <i class="icon demo-list-icon"></i>
          </div>
          <textarea placeholder="请输入批注" id="note3" cols="45" rows="6" class="textarea"></textarea>
          <p class="row">
            <button class="col-30 button button-fill panel-open popup-close" id="add3">添加批注</button>
            <button class="button col-30  popup-close" onclick="getPassage('ture')">取消</button>
          </p>
        </div>
      </div>
    </div>
  </div>

  <script src="js/framework7.min.js"></script>
  <script src="js/app.js"></script>
  <script src="js/rangy-core.js"></script>
  <script src="js/rangy-classapplier.js"></script>
  <script src="js/jquery.min.js"></script>
  <script>
    // 返回
    var back = document.getElementById("back");
    if (back) {
      back.addEventListener('touchstart', function () {
        window.location.href = "joined_courses.html";
      })
    };

    // 用户选中的文字
    var text;

    function getString(n) {
      text = rangy.getSelection().toString();
      console.log(text);
      var string = 'selectedtxt' + n;
      var selectedtxt = document.getElementById(string);
      selectedtxt.innerText = text;
    }

    // 增加新的annotationContent
    function addAnnotationContent(type) {
      var leftID;
      var string = 'note' + type;
      var textarea = document.getElementById(string).value; // 新建批注的评论文字

      $.ajax({
        url: serverPath + '/annotationcontent/addAnnotationcontent',
        type: "POST",
        async: false,
        data: JSON.stringify({
          "annotationid": annotationId,
          "type": type,
          "startpos": start,
          "endpos": end,
          "content": text,
          "paranum": paragraph,
          "comment": textarea
        }),
        contentType: "application/json",
        success: function (data) {
          //annotationContentsCount = annotationContentsCount + 1;
          //$("#count").html("1个批注"); // 更新annotationContent的总数量

          contentId = data.id; // 新建的annotationContent的id
          $$('#ancontent').append(
            '<div class="card cardcss" id="' + contentId + '">' +
            '<blockquote class="blockquote bqcolor' + type + '" id="bq' + contentId + '">' +
            '<p>' + text + '</p>' +
            '</blockquote>' +
            '<div class="card-content cardct blockquote">' +
            '<p  id="an' + contentId + '">' + textarea + '</p>' +
            '</div>' +
            '<div class="card-footer">' +
            '<a class="link popup-open" id="change" data-popup=".popup5" onclick="modify(' + contentId +
            ')">修改</a><a  class="link" id="delete" onclick="del(' + contentId + ')">删除</a>' +
            '</div>' +
            '</div>');
          document.getElementById(string).value = ''; // 清空新增批注的评论框
        },
        error: function () {
          app.dialog.alert("连接服务器失败");
        }
      })
    }

    // 定位选中语句
    var paragraph; // 段落号
    var start; // 起始字符位置
    var end; // 结束字符位置
    var type; // 批注种类

    function getLocation(n) { // n是批注的种类
      // 用户选中的文字Selection对象
      var userSelection;
      if (window.getSelection) {
        userSelection = window.getSelection();
      }

      // 构造Range对象
      var getRangeObject = function (selectionObject) {
        if (selectionObject.getRangeAt)
          return selectionObject.getRangeAt(0);
        else { // 较老版本Safari!
          var range = document.createRange();
          range.setStart(selectionObject.anchorNode, selectionObject.anchorOffset);
          range.setEnd(selectionObject.focusNode, selectionObject.focusOffset);
          return range;
        }
      }
      var rangeObject = getRangeObject(userSelection);

      // 计算段落paragraph
      var par = 0;
      var p = rangeObject.startContainer.parentNode.parentNode;
      while (p = p.previousSibling) {
        par++;
      }
      par = par + 1;
      paragraph = par;

      // 计算字符开始位置start
      var i = 0;
      var startSpan = rangeObject.startContainer.parentNode;
      while (startSpan = startSpan.previousSibling) {
        i++;
      }
      start = i;

      // 计算字符结束位置end
      var j = 0;
      var endSpan = rangeObject.endContainer.parentNode;
      while (endSpan = endSpan.previousSibling) {
        j++;
      }
      end = j + 1; // 左闭右开区间

      // 设置批注类型
      type = n;

      console.log(paragraph, start, end, type);
    }

    //添加批注样式
    function anPaint(bton) {
      rangy.init();
      var classApplierModule = rangy.modules.ClassApplier;
      if (true) {
        switch (bton) {
          case 0:
            cssApplier = rangy.createClassApplier("Bton0Backgrond", false);
            cssApplier.toggleSelection();
            break;
          case 1:
            cssApplier = rangy.createClassApplier("Bton1Backgrond", false);
            cssApplier.toggleSelection();
            break;
          case 2:
            cssApplier = rangy.createClassApplier("Bton2Backgrond", false);
            cssApplier.toggleSelection();
            break;
          case 3:
            cssApplier = rangy.createClassApplier("Bton3Backgrond", false);
            cssApplier.toggleSelection();
            break;
        }
      }
    };

    var reg = new RegExp("(^|&)id=([^&]*)(&|$)");
    var r = window.location.search.substr(1).match(reg);

    var ancount; //统计批注数量，用于数量随时变化


    var articleId; // 文章id
    var annotationId; // 批注id

    //获取批注annotation
    function getAnnotation() {
      var userId = localStorage.userid;
      var courseId = localStorage.courseid;

      $.ajax({
        url: serverPath + '/annotation/getStudentAnnotation',
        type: "GET",
        async: false,
        data: { userId: userId, courseId: courseId },
        success: function (data) {
          articleId = data.articleid; // 获取文章id
          annotationId = data.id; // 获取批注id
          var score = data.score;
          if (score == -1) {
            $("#score").html('分数: 未评分');
          } else {
            $("#score").html('分数: ' + score);
          }
        },
        error: function () {
          app.dialog.alert("连接服务器失败");
        }
      })
    };
    $(function () {
      getAnnotation();
    })

    //获取文章并格式化在html元素中
    function getArticle() {
      $.ajax({
        url: serverPath + '/article/' + articleId,
        type: "GET",
        async: false,
        success: function (data) {
          $("#title").html("《" + data.title + "》");
          var content = data.content;
          var paraList = content.split('/p');
          var htmlContent = "";
          paraList.forEach(function (para) {
            paraContent = "";

            var charList = para.split("");
            charList.forEach(function (char) {

              paraContent = paraContent + '<span>' + char + '</span>';
            })
            htmlContent = htmlContent + '<p>' + paraContent + '</p>';
          })
          $("#box").html(htmlContent);

          getAnnotationContents(annotationId);
        },
        error: function (e) {
          app.dialog.alert("连接服务器失败");
        }
      })
    };
    $(function () {
      getArticle()
    })

    // 传递annotationContent的参数
    var par; // 段落号
    var st; // 开始位置
    var ed; // 结束位置
    var type; // 批注种类
    var contentId; // id
    var content; // 选中文本
    var comment; // 批注评论

    // 获取annotation包含的所有annotationContent
    function getAnnotationContents(annotationId) {
      $.ajax({
        url: serverPath + '/annotationcontent/getContentsByAnnotationId',
        type: "GET",
        data: { annotationId: annotationId },
        async: false,
        success: function (data) {
          ancount = data.length;
          $("#count").html(ancount + "个批注");
          parse(data);
        },
        error: function (e) {
          app.dialog.alert("连接服务器失败");
        }
      })
    };


    // 逐条解析annotationContent的位置、文本内容、评论等信息
    function parse(contents) {
      $.each(contents, function (i, item) {
        par = item.paranum; // 段落号
        st = item.startpos; // 开始位置
        ed = item.endpos; // 结束位置
        type = item.type; // 批注种类
        contentId = item.id; // id
        content = item.content; // 选中文本
        comment = item.comment; // 批注评论

        render();
        leftPanel();
      })
    }

    // 渲染annotationContent
    function render() {
      var px = $$("#box p")[par - 1]; // 根据段落号找到对应的<p>元素
      // 根据annotationContent的信息创建对应的range对象
      var range = rangy.createRange();
      range.setStart(px, st);
      range.setEnd(px, ed);
      range.select();
      // 根据批注的种类，渲染对应的特效
      switch (type) {
        case 0:
          cssApplier = rangy.createClassApplier("Bton0Backgrond", false);
          break;
        case 1:
          cssApplier = rangy.createClassApplier("Bton1Backgrond", false);
          break;
        case 2:
          cssApplier = rangy.createClassApplier("Bton2Backgrond", false);
          break;
        case 3:
          cssApplier = rangy.createClassApplier("Bton3Backgrond", false);
          break;
      }
      cssApplier.toggleSelection();
      window.getSelection().removeAllRanges();
    }

    // 加载左侧边栏批注
    function leftPanel() {
      var string = 'note' + type;

      $$('#ancontent').append(
        '<div class="card cardcss" id="' + contentId + '">' +
        '<blockquote class="blockquote bqcolor' + type + '" id="bq' + contentId + '">' +
        '<p>' + content + '</p>' +
        '</blockquote>' +
        '<div class="card-content cardct blockquote">' +
        '<p  id="an' + contentId + '">' + comment + '</p>' +
        '</div>' +
        '<div class="card-footer">' +
        '<a class="link popup-open" id="change" data-popup=".popup5" onclick="modify(' + contentId +
        ')">修改</a><a  class="link" id="delete" onclick="del(' + contentId + ')">删除</a>' +
        '</div>' +
        '</div>');

      document.getElementById(string).value = '';
    }

    // 加载右侧边栏批注
    function rightPanel() {

      var courseId = localStorage.courseid;
      // 查找本课程教师的annotation
      $.ajax({
        url: serverPath + '/annotation/getTeacherAnnotation',
        type: "GET",
        data: { courseId: courseId },
        async: false,
        success: function (data) {
          var teacherAnnotationId = data.id;
          if (teacherAnnotationId == -1) {
            $$('#ancontent2').append(
              `    <div class="card cardcss" id="` + "student" + `">
          <blockquote class="blockquote bqcolor` + 3 + `">
            <p id="viewTeacherAnnotation">教师批注</p>
          </blockquote>
            <div class="card-footer">
              <a>状态: 未发布</a>
            </div>
          </div>`
            );
          } else {
            $$('#ancontent2').append(
              `    <div class="card cardcss" id="` + "student" + `">
          <blockquote class="blockquote bqcolor` + 3 + `">
            <p class="link" id="viewTeacherAnnotation" onclick="viewTeacherAnnotation()">教师批注</p>
          </blockquote>
            <div class="card-footer">
              <a>状态: 已发布</a>
            </div>
          </div>`
            );
          }
        },
        error: function (e) {
          app.dialog.alert("连接服务器失败");
        }
      })

      // 查找本课程优秀学生批注 top5
      $.ajax({
        url: serverPath + '/annotation/getTopNAnnotationsByCourseId',
        type: "GET",
        data: { courseId: courseId, n: 5 },
        async: false,
        success: function (data) {
          data = data.reverse();
          $.each(data, function (i, item) {
            var studentId = item.userid; // 学生的id
            var annotationId = item.id; // 批注的id
            var score = item.score; // 分数

            $.ajax({
              url: serverPath + '/user/' + studentId,
              type: "GET",
              async: false,
              success: function (data) {
                var studentName = data.name; // 学生的name
                $$('#ancontent2').append(
                  `    <div class="card cardcss" id="` + "student" + `">
          <blockquote class="blockquote bqcolor` + 0 + `">
            <p class="link" id="viewStudentAnnotation" onclick="viewStudentAnnotation(`+ annotationId + `)">` + studentName + `</p>
          </blockquote>
            <div class="card-footer">
              <a>分数: `+ score + `</a>
            </div>
          </div>`
                );
              },
              error: function (e) {
                app.dialog.alert("连接服务器失败");
              }
            })
          })
        },
        error: function (e) {
          app.dialog.alert("连接服务器失败");
        }
      })
    };
    $(function () {
      rightPanel()
    })

    // 查看教师批注
    function viewTeacherAnnotation() {
      localStorage.viewid = 0;
      window.location.href = "view_annotation.html";
    }
    // 查看学生批注
    function viewStudentAnnotation(annotationId) {
      localStorage.viewid = annotationId;
      window.location.href = "view_annotation.html"
    }


    // 删除批注
    function del(contentId) {
      $.ajax({
        url: serverPath + '/annotationcontent/' + contentId,
        type: "DELETE",
        async: false,
        success: function (data) {
          app.dialog.alert("删除成功", '', function () {
            location.reload();
          });
        },
        error: function () {
          app.dialog.alert("连接服务器失败");
        }
      })
    };

    // 修改批注
    function modify(contentId) {
      var x = $$('#an' + contentId).text(); //获取批注的文章内容
      var t = $$('#bq' + contentId + '>p').text(); //获得原批注
      var bqcolor = $$('#bq' + contentId).attr('class'); //获得颜色样式
      $$('#sendID').text(contentId); //传递id
      $$('#old').text(t); //传递原批注
      $$('#mod').val(x); //传递文章内容到popup
      $$('#bqcolor').attr('class', bqcolor);
    }

    var ad = document.getElementById("modadd"); //获得修改批注按钮
    ad.addEventListener('touchstart', function () {
      add(); //重新调用添加批注函数来实现修改批注
    });

    function add() {
      var nw = $$('#mod').val(); // 修改后的comment
      var getID = $$('#sendID').text(); // 要修改的annotationContent的id
      $$('#an' + getID).text(nw);


      // stupid
      var annid;
      var typ;
      var stapos;
      var enpos;
      var panum;
      var cont;

      $.ajax({
        url: 'http://118.31.76.154:8080/Entity/U1e95abf6975ff/annotation/Annotationcontent/'+getID,
        type: "GET",
        async: false,
        success: function (data) {
          annid = data.annotationid;
          typ = data.type;
          stapos = data.startpos;
          enpos = data.endpos;
          panum = data.paranum;
          cont = data.content;
        },
        error: function () {
          app.dialog.alert("连接服务器失败");
        }
      })


      $.ajax({
        url: 'http://118.31.76.154:8080/Entity/U1e95abf6975ff/annotation/Annotationcontent/'+getID,
        type: "PUT",
        data: JSON.stringify({
          "comment": nw,
          "annotationid" : annid,
          "type" : typ,
          "startpos": stapos,
          "endpos":enpos,
          "paranum":panum,
          "content":cont
        }),
        contentType: "application/json",
        async: false,
        success: function (data) {
          app.dialog.alert("修改成功");
        },
        error: function () {
          app.dialog.alert("连接服务器失败");
        }
      })
    }

    // 页面上随时改变批注数量的方法
    function addNum() {
      ancount++;
      $("#count").html(ancount + '个批注');
      $("#allantate").text(ancount);
    }

    function rdNum() {
      ancount--;
      $("#count").html(ancount + '个批注');
      $("#allantate").text(ancount);
    }

    // 底部工具栏按钮事件
    var button0 = document.getElementById("button0");
    button0.addEventListener('touchstart', function () {
      getString(0);
      anPaint(0);
      getLocation(0);

      if (text && text != null) {
        app.popup.open(".popup0")
      }
    });

    var botton1 = document.getElementById("button1");
    button1.addEventListener('touchstart', function () {
      getString(1);
      anPaint(1);
      getLocation(1);

      if (text && text != null) {
        app.popup.open(".popup1")
      }
    });

    var botton2 = document.getElementById("button2");
    button2.addEventListener('touchstart', function () {
      getString(2);
      anPaint(2);
      getLocation(2);

      if (text && text != null) {
        app.popup.open(".popup2")
      }
    });

    var botton3 = document.getElementById("button3");
    button3.addEventListener('touchstart', function () {
      getString(3);
      anPaint(3);
      getLocation(3);

      if (text && text != null) {
        app.popup.open(".popup3")
      }
    });

    //添加批注按钮点击事件
    var add0 = document.getElementById("add0");
    add0.addEventListener('touchstart', function () {
      addAnnotationContent(0);
      addNum();
    });

    var add1 = document.getElementById("add1");
    add1.addEventListener('touchstart', function () {
      addAnnotationContent(1);
      addNum();
    });

    var add2 = document.getElementById("add2");
    add2.addEventListener('touchstart', function () {
      addAnnotationContent(2);
      addNum();
    });

    var add3 = document.getElementById("add3");
    add3.addEventListener('touchstart', function () {
      addAnnotationContent(3);
      addNum();
    });

  </script>
</body>

</html>